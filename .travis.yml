# Travis CI build configuration config file.
# Used environment variables (see: http://docs.travis-ci.com/user/ci-environment/):
#   TRAVIS_BUILD_DIR - The absolute path to the directory where the repository being built has been copied on the worker. (e.g. "/home/travis/build/mycognitive/ads")
#   TRAVIS_REPO_SLUG - The slug (in form: owner_name/repo_name) of the repository currently being built. (e.g. "mycognitive/ads_features")

before_install:
# Use this to prepare the system to install prerequisites or dependencies.
# Commonly used to update git repository submodules and do similar tasks that need to be performed before dependencies are installed.
  - env
  - sudo sysctl kernel.hostname=ads.localhost

install:
# Use this to install any prerequisites or dependencies necessary to run your build.
  - echo -e "Host github.com\n User git\n StrictHostKeyChecking no\n PasswordAuthentication no\n CheckHostIP no\n BatchMode yes\n" >> ~/.ssh/config
  - git clone https://github.com/mycognitive/ads ads && cd ads
  - sh ./configure install
  - sudo puppet apply puppet/travis.pp && sudo puppet apply puppet/ads.dev.pp && sudo puppet apply puppet/solr.dev.pp && sudo puppet module list

before_script:
# Use this to prepare your build for testing (e.g. copy database configurations, environment variables, etc.).
  - cat travis/travis.known_hosts | tee -a ~/.ssh/known_hosts # Append Travis known_hosts to user file.
  - cat /etc/ssh/ssh_config ~/.ssh/config ~/.ssh/known_hosts  # Display content of configuration files.
  - ln -s travis/travis.build.properties build.properties     # Prepare build.properties file.
  - sudo puppet apply puppet/ads.dev.configure-site.pp        # Apply webroot puppet configuration.
  - echo "USE mysql;\nUPDATE user SET password=PASSWORD('root') WHERE user='root';\nFLUSH PRIVILEGES;\n" | mysql -uroot
  - echo "CREATE DATABASE travis_ads_test DEFAULT CHARACTER SET utf8" | mysql -uroot -proot

script:
# All commands must exit with code 0 on success. Anything else is considered failure.
  - make
  - make install
# - sudo mkdir /var/www/ads                                   # Create webroot folder.
  - sudo mv $TRAVIS_BUILD_DIR/src $SRCDIR/ads
  - rm  -fr "$SRCDIR/sites/all/modules/ads/`basename $TRAVIS_REPO_SLUG`" && echo $0
  - ln -sfv "$SRCDIR/sites/all/modules/ads/`basename $TRAVIS_REPO_SLUG`" $TRAVIS_BUILD_DIR
  - sudo chmod -R 777 $SRCDIR/
  - cd $SRCDIR && pwd && ls && echo "$DRUSH" && $DRUSH -y en simpletest && php ./scripts/run-tests.sh --php `which php` --url http://ads.localhost/ --concurrency 16 --verbose System

# Note: The standard Unix exit code of "0" means the build passed; everything else is treated as failure.
after_success:
  - which html2text || sudo apt-get install html2text
  - $SRCDIR/scripts/drupal.sh http://ads.localhost/ | html2text
  - pwd && drush status-report --severity=2

after_failure:
  - pwd
  - env
  - drush --version && drush status-report # Check drush version and status report.

after_script:
# Test result is exported to TRAVIS_TEST_RESULT.
  - pwd

env:
  - GIT_TRACE=1 GIT_SSH="/usr/bin/ssh -oStrictHostKeyChecking=no " SRCDIR="/var/www/ads" DRUSH="drush -y -r $SRCDIR --uri=http://ads.localhost/"

notifications:
  email: false

addons:
  hosts:
    - ads.localhost

language: php

php:
  - 5.3
